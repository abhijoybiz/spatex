(function(E,D){typeof exports=="object"&&typeof module<"u"?D(exports,require("three")):typeof define=="function"&&define.amd?define(["exports","three"],D):(E=typeof globalThis<"u"?globalThis:E||self,D(E.Spatex={},E.THREE))})(this,function(E,D){"use strict";function ae(n){const a=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(n){for(const t in n)if(t!=="default"){const r=Object.getOwnPropertyDescriptor(n,t);Object.defineProperty(a,t,r.get?r:{enumerable:!0,get:()=>n[t]})}}return a.default=n,Object.freeze(a)}const o=ae(D),F={_universal:{pos:[0,0,0],rotate:[0,0,0],color:"#cccccc",opacity:1,wireframe:!1,shadow:!1,label:null},cube:{size:1},cuboid:{width:1,height:1,depth:1},sphere:{radius:1},hemisphere:{radius:1},cylinder:{radius:1,height:2},hollow_cylinder:{radius:1,inner_radius:.5,height:2,thickness:null},cone:{radius:1,height:2},hollow_cone:{radius:1,inner_radius:.5,height:2,thickness:null},square:{size:1},rectangle:{width:2,height:1},circle:{radius:1},semicircle:{radius:1},triangle:{size:1},plane:{width:10,height:10}},H={background:"#000000",fog:!1},X={angle:[45,30],zoom:1,target:[0,0,0]},J=new Set(["arrow","line"]);new Set(Object.keys(F).filter(n=>n!=="_universal"));function ce(n){const a=[];let t=0;const r=n.length;for(;t<r;){const c=n[t];if(/\s/.test(c)){t++;continue}if(c==="/"&&n[t+1]==="*"){for(t+=2;t<r&&!(n[t]==="*"&&n[t+1]==="/");)t++;t+=2;continue}if(c==="/"&&n[t+1]==="/"){for(;t<r&&n[t]!==`
`;)t++;continue}if(c==="{"){a.push({type:"LBRACE",value:"{"}),t++;continue}if(c==="}"){a.push({type:"RBRACE",value:"}"}),t++;continue}if(c===":"){a.push({type:"COLON",value:":"}),t++;continue}if(c===";"){a.push({type:"SEMI",value:";"}),t++;continue}if(c==='"'||c==="'"){const p=c;t++;let g="";for(;t<r&&n[t]!==p;)n[t]==="\\"?(t++,g+=n[t]||""):g+=n[t],t++;t++,a.push({type:"STRING",value:g});continue}if(c==="#"){let p="#";for(t++;t<r&&/[0-9a-fA-F]/.test(n[t]);)p+=n[t],t++;a.push({type:"HASH",value:p});continue}if(/[0-9]/.test(c)||c==="-"&&t+1<r&&/[0-9.]/.test(n[t+1])){let p="";for(c==="-"&&(p+="-",t++);t<r&&/[0-9.]/.test(n[t]);)p+=n[t],t++;a.push({type:"NUMBER",value:parseFloat(p)});continue}if(/[a-zA-Z_]/.test(c)){let p="";for(;t<r&&/[a-zA-Z0-9_]/.test(n[t]);)p+=n[t],t++;a.push({type:"WORD",value:p});continue}t++}return a}function U(n){const a=ce(n);let t=0;const r=()=>a[t]||null,c=()=>a[t++],p=d=>{const m=c();if(!m||m.type!==d)throw new Error(`Expected ${d}, got ${m?m.type+"("+m.value+")":"EOF"} at #${t-1}`);return m};function g(){return t+1<a.length&&a[t].type==="WORD"&&a[t+1].type==="COLON"}function S(){const d=r();if(!d||d.type!=="WORD")return!1;const m=a[t+1];return!!(m&&m.type==="LBRACE"||m&&m.type==="WORD"&&a[t+2]&&a[t+2].type==="LBRACE")}function b(){const d=r();if(!d)throw new Error("Unexpected EOF in value");if(d.type==="STRING"||d.type==="HASH")return c(),d.value;if(d.type==="WORD"&&(d.value==="true"||d.value==="false"))return c(),d.value==="true";if(d.type==="NUMBER"){const m=[];for(;r()&&r().type==="NUMBER";)m.push(c().value);return m.length===1?m[0]:m}if(d.type==="WORD")return c(),d.value;throw new Error(`Unexpected token ${d.type}(${d.value}) in value`)}function R(){const d={},m=[];for(;r()&&r().type!=="RBRACE";)if(g()){const k=c().value;p("COLON");const z=b();d[k]=z,r()&&r().type==="SEMI"&&c()}else S()?m.push(V()):c();return{properties:d,children:m}}function V(){const d=p("WORD").value;let m=null;r()&&r().type==="WORD"&&(m=c().value),p("LBRACE");const{properties:k,children:z}=R();return p("RBRACE"),{type:d,name:m,properties:k,children:z}}p("WORD"),p("LBRACE");const{properties:$,children:W}=R();return p("RBRACE"),le($,W)}function le(n,a){const t={type:"scene",background:n.background||H.background,fog:n.fog!==void 0?n.fog:H.fog,camera:{...X},objects:[],connectors:[]},r={},c=[];for(const p of a)if(p.type==="camera")t.camera=ue(p.properties);else if(J.has(p.type))c.push(p);else if(p.type==="group"){const g=Z(p,r);t.objects.push(g)}else t.objects.push(Q(p,r));return t.connectors=c.map(p=>K(p,r)),t}function ue(n){return{angle:T(n.angle,2,X.angle),zoom:n.zoom!==void 0?n.zoom:X.zoom,target:T(n.target,3,X.target)}}function Q(n,a){const t={type:n.type,name:n.name||null,...ee(F._universal)};F[n.type]&&Object.assign(t,ee(F[n.type]));for(const[r,c]of Object.entries(n.properties))r==="pos"?t.pos=T(c,3,[0,0,0]):r==="rotate"?t.rotate=T(c,3,[0,0,0]):t[r]=c;return n.name&&(a[n.name]=t),t}function Z(n,a){const t={type:"group",name:n.name||null,pos:T(n.properties.pos,3,[0,0,0]),rotate:T(n.properties.rotate,3,[0,0,0]),children:[],connectors:[]};for(const r of n.children)J.has(r.type)?t.connectors.push(r):r.type==="group"?t.children.push(Z(r,a)):t.children.push(Q(r,a));return t.connectors=t.connectors.map(r=>K(r,a)),n.name&&(a[n.name]=t),t}function K(n,a){const t=n.properties;return{type:n.type,name:n.name||null,from:j(t.from,a),to:j(t.to,a),color:t.color||"#ffffff",thickness:t.thickness!==void 0?t.thickness:1,label:t.label||null}}function j(n,a){return typeof n=="string"&&a[n]?{ref:n,pos:[...a[n].pos]}:Array.isArray(n)?{ref:null,pos:T(n,3,[0,0,0])}:typeof n=="number"?{ref:null,pos:[n,0,0]}:typeof n=="string"?{ref:n,pos:[0,0,0]}:{ref:null,pos:[0,0,0]}}function T(n,a,t){if(Array.isArray(n)){const r=n.slice(0,a);for(;r.length<a;)r.push(0);return r}if(typeof n=="number"){const r=[n];for(;r.length<a;)r.push(0);return r}return t?[...t]:new Array(a).fill(0)}function ee(n){return JSON.parse(JSON.stringify(n))}function q(n,a){const t=a.clientWidth||900,r=500,c=new o.Scene,p=new o.WebGLRenderer({antialias:!0,alpha:!1});if(p.setSize(t,r),p.setPixelRatio(Math.min(window.devicePixelRatio,2)),p.shadowMap.enabled=!0,p.shadowMap.type=o.PCFSoftShadowMap,p.outputEncoding=o.sRGBEncoding,p.toneMapping=o.ACESFilmicToneMapping,p.toneMappingExposure=1,a.appendChild(p.domElement),c.background=new o.Color(n.background),n.fog){const e=new o.Color(n.background);c.fog=new o.FogExp2(e,.05)}const g=n.camera,S=new o.PerspectiveCamera(50,t/r,.1,1e3),b=o.MathUtils.degToRad(g.angle[0]),R=o.MathUtils.degToRad(g.angle[1]),V=10/g.zoom;S.position.set(V*Math.cos(R)*Math.sin(b),V*Math.sin(R),V*Math.cos(R)*Math.cos(b)),S.lookAt(new o.Vector3(g.target[0],g.target[1],g.target[2]));const $=new o.AmbientLight(16777215,.5);c.add($);const W=new o.HemisphereLight(16777215,4473924,.4);W.position.set(0,20,0),c.add(W);const d=new o.DirectionalLight(16777215,.8);d.position.set(8,12,8),d.castShadow=!0,d.shadow.mapSize.width=2048,d.shadow.mapSize.height=2048,d.shadow.camera.near=.5,d.shadow.camera.far=50,d.shadow.camera.left=-15,d.shadow.camera.right=15,d.shadow.camera.top=15,d.shadow.camera.bottom=-15,d.shadow.bias=-.001,c.add(d);const m=new o.DirectionalLight(16777215,.25);m.position.set(-5,6,-5),c.add(m);function k(e,i,u){for(const s of e)if(s.type==="group"){const f=new o.Group;if(f.position.set(s.pos[0],s.pos[1],s.pos[2]),s.rotate&&f.rotation.set(o.MathUtils.degToRad(s.rotate[0]),o.MathUtils.degToRad(s.rotate[1]),o.MathUtils.degToRad(s.rotate[2])),i.add(f),k(s.children,f,[u[0]+s.pos[0],u[1]+s.pos[1],u[2]+s.pos[2]]),s.connectors)for(const v of s.connectors)ne(v,f,[0,0,0])}else{const f=z(s);f&&i.add(f)}}function z(e){let i=null,u=null,s=null;const v={color:new o.Color(e.color),wireframe:e.wireframe,transparent:e.opacity<1,opacity:e.opacity,side:o.DoubleSide};switch(u=new o.MeshStandardMaterial(v),e.type){case"cube":i=new o.BoxGeometry(e.size,e.size,e.size);break;case"cuboid":i=new o.BoxGeometry(e.width,e.height,e.depth);break;case"sphere":i=new o.SphereGeometry(e.radius,32,32);break;case"hemisphere":i=new o.SphereGeometry(e.radius,32,16,0,Math.PI*2,0,Math.PI/2);break;case"cylinder":i=new o.CylinderGeometry(e.radius,e.radius,e.height,32);break;case"hollow_cylinder":{const h=e.radius,w=e.inner_radius!==void 0?e.inner_radius:h*.6,y=e.height,M=new o.Shape;M.moveTo(w,-y/2),M.lineTo(h,-y/2),M.lineTo(h,y/2),M.lineTo(w,y/2),M.lineTo(w,-y/2),i=new o.LatheGeometry(M.getPoints(1),32);break}case"cone":i=new o.ConeGeometry(e.radius,e.height,32);break;case"hollow_cone":{const h=e.radius,w=e.inner_radius!==void 0?e.inner_radius:h*.4,y=e.height,M=[new o.Vector2(w*.3,y/2),new o.Vector2(w,-y/2),new o.Vector2(h,-y/2),new o.Vector2(h*.3,y/2)];i=new o.LatheGeometry(M,32);break}case"square":i=new o.PlaneGeometry(e.size,e.size);break;case"rectangle":i=new o.PlaneGeometry(e.width,e.height);break;case"circle":i=new o.CircleGeometry(e.radius,32);break;case"semicircle":i=new o.CircleGeometry(e.radius,32,0,Math.PI);break;case"triangle":{const h=e.size,w=new o.Shape;w.moveTo(0,h*.866/2),w.lineTo(-h/2,-h*.866/2),w.lineTo(h/2,-h*.866/2),w.lineTo(0,h*.866/2),i=new o.ShapeGeometry(w);break}case"plane":i=new o.PlaneGeometry(e.width,e.height);break;case"label":{const h=Y(e.label||e.name||"label",e.color);return h.position.set(e.pos[0],e.pos[1],e.pos[2]),h.scale.set(2,1,1),h}default:return console.warn(`[SpaTeX] Unknown shape type: "${e.type}"`),null}if(s=new o.Mesh(i,u),s.position.set(e.pos[0],e.pos[1],e.pos[2]),s.rotation.set(o.MathUtils.degToRad(e.rotate[0]),o.MathUtils.degToRad(e.rotate[1]),o.MathUtils.degToRad(e.rotate[2])),e.shadow&&(s.castShadow=!0,s.receiveShadow=!0),e.label){const h=Y(e.label,"#ffffff"),y=new o.Box3().setFromObject(s).max.y-e.pos[1]+.4;h.position.set(0,y,0),h.scale.set(2.5,.6,1),s.add(h)}return s}function Y(e,i){const u=document.createElement("canvas"),s=u.getContext("2d");u.width=512,u.height=128,s.clearRect(0,0,u.width,u.height);const f=20;s.font="bold 48px Inter, Arial, sans-serif";const h=s.measureText(e).width,w=Math.min(h+f*2,u.width),y=72,M=(u.width-w)/2,L=(u.height-y)/2;s.fillStyle="rgba(0, 0, 0, 0.55)",te(s,M,L,w,y,16),s.fill(),s.strokeStyle="rgba(255, 255, 255, 0.15)",s.lineWidth=2,te(s,M,L,w,y,16),s.stroke(),s.fillStyle=i||"#ffffff",s.textAlign="center",s.textBaseline="middle",s.font="bold 44px Inter, Arial, sans-serif",s.fillText(e,u.width/2,u.height/2);const C=new o.CanvasTexture(u);C.minFilter=o.LinearFilter,C.magFilter=o.LinearFilter;const G=new o.SpriteMaterial({map:C,transparent:!0,depthTest:!1,depthWrite:!1});return new o.Sprite(G)}function te(e,i,u,s,f,v){e.beginPath(),e.moveTo(i+v,u),e.lineTo(i+s-v,u),e.quadraticCurveTo(i+s,u,i+s,u+v),e.lineTo(i+s,u+f-v),e.quadraticCurveTo(i+s,u+f,i+s-v,u+f),e.lineTo(i+v,u+f),e.quadraticCurveTo(i,u+f,i,u+f-v),e.lineTo(i,u+v),e.quadraticCurveTo(i,u,i+v,u),e.closePath()}function ne(e,i,u){const s=u[0],f=u[1],v=u[2],h=new o.Vector3(e.from.pos[0]+s,e.from.pos[1]+f,e.from.pos[2]+v),w=new o.Vector3(e.to.pos[0]+s,e.to.pos[1]+f,e.to.pos[2]+v),y=new o.Vector3().subVectors(w,h),M=y.length();if(M<.001)return;const L=new o.Color(e.color);if(e.type==="arrow"){const C=Math.min(M*.2,.5),G=.15,B=M-C,I=new o.CylinderGeometry(.04,.04,B,8),O=new o.MeshStandardMaterial({color:L}),ie=new o.Mesh(I,O),de=new o.ConeGeometry(G,C,8),he=new o.MeshStandardMaterial({color:L}),re=new o.Mesh(de,he),_=new o.Group;ie.position.set(0,B/2,0),_.add(ie),re.position.set(0,B+C/2,0),_.add(re),_.position.copy(h);const fe=new o.Vector3(0,1,0),ge=new o.Quaternion().setFromUnitVectors(fe,y.clone().normalize());if(_.setRotationFromQuaternion(ge),i.add(_),e.label){const me=new o.Vector3().addVectors(h,w).multiplyScalar(.5),N=Y(e.label,"#ffffff");N.position.copy(me),N.position.x+=.5,N.scale.set(2,.5,1),i.add(N)}}else if(e.type==="line"){const C=new o.BufferGeometry().setFromPoints([h,w]),G=new o.LineBasicMaterial({color:L,linewidth:e.thickness}),B=new o.Line(C,G);if(i.add(B),e.label){const I=new o.Vector3().addVectors(h,w).multiplyScalar(.5),O=Y(e.label,"#ffffff");O.position.copy(I),O.position.y+=.3,O.scale.set(2,.5,1),i.add(O)}}}k(n.objects,c,[0,0,0]);for(const e of n.connectors)ne(e,c,[0,0,0]);const l={target:new o.Vector3(g.target[0],g.target[1],g.target[2]),spherical:new o.Spherical().setFromVector3(S.position.clone().sub(new o.Vector3(g.target[0],g.target[1],g.target[2]))),isDragging:!1,isPanning:!1,prevMouse:{x:0,y:0},rotateSpeed:.005,panSpeed:.01};function oe(e){return Math.max(.05,Math.min(Math.PI-.05,e))}const x=p.domElement;x.addEventListener("mousedown",e=>{e.button===0&&(l.isDragging=!0),(e.button===2||e.button===1)&&(l.isPanning=!0),l.prevMouse={x:e.clientX,y:e.clientY}}),x.addEventListener("contextmenu",e=>e.preventDefault()),window.addEventListener("mouseup",()=>{l.isDragging=!1,l.isPanning=!1}),window.addEventListener("mousemove",e=>{const i=e.clientX-l.prevMouse.x,u=e.clientY-l.prevMouse.y;if(l.prevMouse={x:e.clientX,y:e.clientY},l.isDragging&&(l.spherical.theta-=i*l.rotateSpeed,l.spherical.phi-=u*l.rotateSpeed,l.spherical.phi=oe(l.spherical.phi)),l.isPanning){const s=new o.Vector3,f=new o.Vector3;S.matrix.extractBasis(s,f,new o.Vector3),l.target.addScaledVector(s,-i*l.panSpeed),l.target.addScaledVector(f,u*l.panSpeed)}}),x.addEventListener("wheel",e=>{e.preventDefault();const i=1+e.deltaY*.001;l.spherical.radius*=i,l.spherical.radius=Math.max(1,Math.min(100,l.spherical.radius))},{passive:!1});let P=0,A=null;x.addEventListener("touchstart",e=>{if(e.preventDefault(),e.touches.length===1)l.isDragging=!0,l.prevMouse={x:e.touches[0].clientX,y:e.touches[0].clientY};else if(e.touches.length===2){l.isDragging=!1;const i=e.touches[0].clientX-e.touches[1].clientX,u=e.touches[0].clientY-e.touches[1].clientY;P=Math.sqrt(i*i+u*u),A={x:(e.touches[0].clientX+e.touches[1].clientX)/2,y:(e.touches[0].clientY+e.touches[1].clientY)/2}}},{passive:!1}),x.addEventListener("touchmove",e=>{if(e.preventDefault(),e.touches.length===1&&l.isDragging){const i=e.touches[0].clientX-l.prevMouse.x,u=e.touches[0].clientY-l.prevMouse.y;l.prevMouse={x:e.touches[0].clientX,y:e.touches[0].clientY},l.spherical.theta-=i*l.rotateSpeed,l.spherical.phi-=u*l.rotateSpeed,l.spherical.phi=oe(l.spherical.phi)}else if(e.touches.length===2){const i=e.touches[0].clientX-e.touches[1].clientX,u=e.touches[0].clientY-e.touches[1].clientY,s=Math.sqrt(i*i+u*u);if(P>0){const h=P/s;l.spherical.radius*=h,l.spherical.radius=Math.max(1,Math.min(100,l.spherical.radius))}P=s;const f=(e.touches[0].clientX+e.touches[1].clientX)/2,v=(e.touches[0].clientY+e.touches[1].clientY)/2;if(A){const h=f-A.x,w=v-A.y,y=new o.Vector3,M=new o.Vector3;S.matrix.extractBasis(y,M,new o.Vector3),l.target.addScaledVector(y,-h*l.panSpeed),l.target.addScaledVector(M,w*l.panSpeed)}A={x:f,y:v}}},{passive:!1}),x.addEventListener("touchend",()=>{l.isDragging=!1,P=0,A=null});function se(){requestAnimationFrame(se);const e=new o.Vector3().setFromSpherical(l.spherical);S.position.copy(l.target).add(e),S.lookAt(l.target),p.render(c,S)}return se(),new ResizeObserver(()=>{const e=a.clientWidth,i=500;S.aspect=e/i,S.updateProjectionMatrix(),p.setSize(e,i)}).observe(a),{scene:c,camera:S,renderer:p}}const pe={parse(n){return U(n)},render(n,a){const t=U(n);return q(t,a)},autoRender(){const n=["code.language-spatex","code.language-3d"];document.querySelectorAll(n.join(", ")).forEach((t,r)=>{const c=t.textContent.trim(),p=t.parentElement;try{const g=U(c);console.log(`%c[SpaTeX] Scene #${r+1} parsed:`,"color: #6366f1; font-weight: bold;",g);const S=document.createElement("div");S.className="spatex-container",S.id=`spatex-scene-${r}`;const b=document.createElement("div");b.className="spatex-badge",b.textContent="SpaTeX",S.appendChild(b);const R=document.createElement("div");R.className="spatex-controls-hint",R.textContent="ðŸ–± Drag to orbit Â· Scroll to zoom Â· Right-drag to pan",S.appendChild(R),p.replaceWith(S),q(g,S),setTimeout(()=>{R.style.opacity="0",setTimeout(()=>R.remove(),500)},4e3)}catch(g){console.error(`[SpaTeX] Error in scene #${r+1}:`,g),t.style.borderColor="#ef4444",t.style.color="#fca5a5",t.textContent=`Parse Error: ${g.message}

${c}`}})}};E.default=pe,E.parse=U,E.render=q,Object.defineProperties(E,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
